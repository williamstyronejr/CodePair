name: deploy

on:
  push:
    branches: [main]
  pull_request: {}

jobs:
  main:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Setup node
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Install dep
        uses: bahmutov/npm-install@v1
        with:
          working-directory: |
            server
            client
            launcher

      - name: Build images
        run: docker build ./launcher --no-cache -t ${{secrets.IMAGE_NODE}}

      - name: Run Client Tests
        run: npm run test --prefix client

      - name: Run Server Tests
        run: npm run test --prefix server

      - name: Server/Client Deploy
        #  Only deploy main branch on pushes
        if: ${{ github.ref == 'refs/heads/main' && github.event_name == 'push' }}
        uses: appleboy/ssh-action@master
        with:
          host: ${{secrets.SSH_CLIENT_HOST}}
          username: ${{secrets.SSH_CLIENT_USERNAME}}
          key: ${{secrets.SSH_KEY}}
          passphrase: ${{secrets.SSH_PASSPHRASE}}
          script: |
            source ~/.bashrc
            nvm use default
            cd app
            git pull
            cd client
            npm install
            npm run build
            cd ..
            cd server
            npm install
            npm run production

      - name: Launcher Deployer
        #  Only deploy main branch on pushes
        if: ${{ github.ref == 'refs/heads/main' && github.event_name == 'push' }}
        uses: appleboy/ssh-action@master
        with:
          host: ${{secrets.SSH_HOST}}
          username: ${{secrets.SSH_USERNAME}}
          key: ${{secrets.SSH_KEY}}
          passphrase: ${{secrets.SSH_PASSPHRASE}}
          script: |
            source ~/.bashrc
            nvm use default
            cd app
            git pull
            npm install
            cd launcher
            npm install
            docker build . --no-cache -t ${{secrets.IMAGE_NODE}}
            cd ..
            npm run launcher:prod
